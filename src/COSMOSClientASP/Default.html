<!DOCTYPE html>
<html>
<head>
    <title>Job Dash Board</title>
    <style type="text/css">
        .container {
            background-color: #99CCFF;
            border: thick solid #808080;
            padding: 20px;
            margin: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loginContainer">
            <table>
                <tr>
                    <td><label for="username">User Name:</label></td>
                    <td><input type="text" id="username" /></td>
                </tr>
                <tr>
                    <td><label for="password">Password:</label></td>
                    <td><input type="password" id="password" /></td>
                </tr>
                <tr>
                    <td></td>
                    <td align="right"><input type="submit" id="login" value="Login" /></td>
                </tr>
            </table>
        </div>
        <input type="button" id="submitJob" value="Submit Jobs" />
        <ul id="discussion"></ul>
    </div>
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-1.6.4.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="http://localhost:5053/signalr/hubs"></script>
    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">
        $(function () {
            $('#username').keyup(doCheck).focusout(doCheck);
            $('#login').prop('disabled', true);
            $('#submitJob').prop('disabled', true);
            //Set the hubs URL for the connection
            $.connection.hub.url = "http://localhost:5053/signalr";

            // Declare a proxy to reference the hub.
            var chat = $.connection.webApiPersistentConnection;

            // Create a function that the hub can call to broadcast messages.
            chat.client.reply = function (serviceMessage) {
                // Html encode display name and message.

                if (serviceMessage.ProcessContext.ProcessType == 'Login') {
                    if (serviceMessage.UserContext != null) {
                        var date = new Date(serviceMessage.UserContext.LastLoginDateTimeUTC);
                        $('#discussion').append('<li>Login Sucessful for <strong>' + serviceMessage.UserContext.UserName + '</strong> Login Previously on: ' + date.toString() + '</li>');
                        userContext = serviceMessage.UserContext;
                    }
                }

                if (serviceMessage.ProcessContext.ProcessType == 'DoJob') {
                    if (serviceMessage.ServiceParams != null) {

                        for (i = 0; i < serviceMessage.ServiceParams.length; i++) {
                            $('#discussion').append('<li><strong>' + serviceMessage.ServiceParams[i] + '</li>');
                        }

                    }
                }
            };


            $('#username').focus();
            var userContext;
            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#login').click(function () {
                    var connectionId = $.connection.hub.id;
                    jQuery.support.cors = true;
                    var loginVo = {
                        UserName: $('#username').val(),
                        Password: $('#password').val()

                    };

                    var processContext = {

                        ProcessId: connectionId,
                        ProcessType: 'Login',
                        TotalNumberOfMessages: 1,
                        MessageNumber: 1,
                        IsLastMessage: true

                    };

                    var serviceParams = [loginVo];
                    var serviceMessage = {
                        ServiceParams: serviceParams,
                        ProcessContext: processContext
                    };

                    $.ajax({
                        url: 'http://localhost:5052/api/COSMOS',
                        type: 'POST',
                        data: JSON.stringify(serviceMessage),
                        contentType: "application/json;charset=utf-8",
                        success: function (returnData) {
                            WriteResponse(returnData, 'Login');
                        },
                        error: function (x, y, z) {
                            alert(x + '\n' + y + '\n' + z);
                        },
                        done: function (param) {
                            WriteResponse(param)
                        }

                    });
                });

                $('#submitJob').click(function () {
                    var connectionId = $.connection.hub.id;
                    jQuery.support.cors = true;
                   

                    var processContext = {

                        ProcessId: connectionId,
                        ProcessType: 'DoJob',
                        TotalNumberOfMessages: 1,
                        MessageNumber: 1,
                        IsLastMessage: true

                    };

                    var serviceParams = ['"Some Text for Job', 'Second text for Job'];
                    var serviceMessage = {
                        ServiceParams: serviceParams,
                        ProcessContext: processContext
                    };

                    $.ajax({
                        url: 'http://localhost:5052/api/COSMOS',
                        type: 'POST',
                        data: JSON.stringify(serviceMessage),
                        contentType: "application/json;charset=utf-8",
                        success: function (returnData) {
                            WriteResponse(returnData, 'DoJob');
                        },
                        error: function (x, y, z) {
                            alert(x + '\n' + y + '\n' + z);
                        },
                        done: function (param) {
                            WriteResponse(param)
                        }

                    });
                });
            }).fail(function (reason) {
                console.log("SignalR connection failed: " + reason);
            });
        });

        function WriteResponse(data, processType) {
            switch (processType) {
                case 'Login':
                    switch (data) {
                        case 1:
                            $('#discussion').append('<li>Call Sucessful </li>');
                            $('#login').prop('disabled', true);
                            $('#username').prop('disabled', true);
                            $('#password').prop('disabled', true);
                            $('#submitJob').prop('disabled', false);
                            break;
                        case 1003:
                            $('#discussion').append('<li>User name or password incorrect</li>');
                            break;
                        case 1006:
                            $('#discussion').append('<li>Password cannot be null</li>');
                            break;
                        default:
                            $('#discussion').append('<li>' + data + '</li>');
                            break;

                    }
                    break;
                case 'DoJob':
                    switch (data) {
                        case 1:
                            $('#discussion').append('<li>Jobs Submitted Sucessfully </li>');
                            break;
                        default:
                            $('#discussion').append('<li>' + data + '</li>');
                            break;

                    }
                    break;
                
            }
        }

        function doCheck() {
            var allFilled = true;
            $('#username').each(function () {
                if ($(this).val() == '') {
                    allFilled = false;
                    return false;
                }
            });
            $('#login').prop('disabled', !allFilled);
        }

        

    </script>
</body>
</html>